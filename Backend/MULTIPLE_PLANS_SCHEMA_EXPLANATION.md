# Multiple Plans Schema Explanation

## Overview

This document explains how the backend handles the case where a user has **multiple plans** in their schedules. This applies to all plan types:
- **Assigned Plans** (web_assigned): Plans assigned by trainer/admin
- **Manual Plans** (manual): Plans created manually by the user
- **AI-Generated Plans** (ai_generated): Plans generated by AI

Users can have multiple plans of the same type on the same date if they come from different sources (different `source_plan_id`).

## Current Schema

### Table: `daily_training_plans`

**Unique Constraint**: `(user_id, plan_date, plan_type, source_plan_id)`

This constraint allows:
- ✅ Multiple plans of the **same type** on the **same date** if they come from **different assignments** (different `source_plan_id`)
- ✅ Multiple plans of **different types** on the same date
- ✅ One plan per unique combination of `(user_id, plan_date, plan_type, source_plan_id)`

### Example Scenarios

#### Scenario 1: Multiple Assigned Plans
A user has 2 assigned plans:
1. **Muscle Gain Plan** (assignment_id: 87, plan_type: 'web_assigned')
2. **Weight Loss Plan** (assignment_id: 88, plan_type: 'web_assigned')

Both plans can have daily plans on the same date (e.g., 2025-12-07) because they have different `source_plan_id` values:

```sql
-- Plan 1: Muscle Gain
user_id: 2
plan_date: 2025-12-07
plan_type: 'web_assigned'
source_plan_id: 87  ← Different assignment

-- Plan 2: Weight Loss  
user_id: 2
plan_date: 2025-12-07
plan_type: 'web_assigned'
source_plan_id: 88  ← Different assignment
```

#### Scenario 2: Multiple Manual Plans
A user has 2 manual plans:
1. **Home Workout Plan** (manual_plan_id: 101, plan_type: 'manual')
2. **Gym Workout Plan** (manual_plan_id: 102, plan_type: 'manual')

Both can have daily plans on the same date:

```sql
-- Plan 1: Home Workout
user_id: 2
plan_date: 2025-12-07
plan_type: 'manual'
source_plan_id: 101  ← Different manual plan

-- Plan 2: Gym Workout
user_id: 2
plan_date: 2025-12-07
plan_type: 'manual'
source_plan_id: 102  ← Different manual plan
```

#### Scenario 3: Multiple AI-Generated Plans
A user has 2 AI-generated plans:
1. **Beginner Plan** (ai_plan_id: 201, plan_type: 'ai_generated')
2. **Advanced Plan** (ai_plan_id: 202, plan_type: 'ai_generated')

Both can have daily plans on the same date:

```sql
-- Plan 1: Beginner
user_id: 2
plan_date: 2025-12-07
plan_type: 'ai_generated'
source_plan_id: 201  ← Different AI plan

-- Plan 2: Advanced
user_id: 2
plan_date: 2025-12-07
plan_type: 'ai_generated'
source_plan_id: 202  ← Different AI plan
```

All these plans **will NOT conflict** because the unique constraint includes `source_plan_id`.

## Key Fields

### `source_plan_id`
- **Purpose**: Links the daily plan to its source (assignment, approval, or manual plan)
- **Type**: Integer (nullable)
- **Values**: 
  - For assigned plans: `training_plan_assignments.id`
  - For manual plans: `app_manual_training_plans.id`
  - For AI plans: `app_ai_generated_plans.id`
  - Can be `NULL` for plans without a clear source

### `plan_type`
- **Purpose**: Categorizes the plan source
- **Type**: String
- **Values**: 
  - `'web_assigned'`: Plans from `training_plan_assignments` (assigned by trainer/admin)
  - `'manual'`: Plans created manually by the user
  - `'ai_generated'`: Plans generated by AI
  - `'stats_record'`: Special record for user statistics (has `is_stats_record = true`)

### `plan_date`
- **Purpose**: The date for which this daily plan is scheduled
- **Type**: Date
- **Format**: `YYYY-MM-DD` (e.g., `'2025-12-07'`)

## How Multiple Plans Are Retrieved

### Endpoint: `GET /api/dailyTraining/mobile/plans`

The backend retrieves all daily plans for a user, grouped by `source_plan_id`:

```javascript
// Plans are grouped by source_plan_id to handle multiple assignments
const plansBySource = {};
plans.forEach(plan => {
  const sourceId = plan.source_plan_id || 'no_source';
  if (!plansBySource[sourceId]) {
    plansBySource[sourceId] = [];
  }
  plansBySource[sourceId].push(plan);
});
```

This allows the frontend to:
1. Display multiple plans separately (e.g., "Muscle Gain" and "Weight Loss")
2. Track progress for each plan independently
3. Complete days for each plan without conflicts

## Migration History

### Migration: `20251207000000_fix_unique_constraint_to_include_source_plan_id.js`

**What it does**:
- Drops the old unique constraint: `(user_id, plan_date, plan_type)`
- Creates a new unique constraint: `(user_id, plan_date, plan_type, source_plan_id)`

**Why it was needed**:
- The old constraint prevented users from having multiple plans of the same type on the same date
- This caused issues when users had multiple assigned plans (e.g., 2 "web_assigned" plans from different assignments)
- The new constraint allows multiple plans as long as they have different `source_plan_id` values

## Code Changes

### All Plan Creation Functions Updated

All functions that create daily plans have been updated to:
1. Check for existing plans using `(user_id, plan_date, plan_type, source_plan_id)`
2. Handle duplicate key errors gracefully with try-catch blocks

#### Functions Updated:
1. **`createDailyPlansFromTrainingApproval`** - For assigned plans (web_assigned)
2. **`syncDailyPlansFromManualPlanHelper`** - For manual plans
3. **`syncDailyPlansFromAIPlanHelper`** - For AI-generated plans

**Before**: Checked for existing plans using only `(user_id, plan_date, plan_type)`

**After**: Checks for existing plans using `(user_id, plan_date, plan_type, source_plan_id)` and handles duplicate key errors gracefully

```javascript
// OLD (would find wrong plan if multiple exist)
const existing = await db('daily_training_plans')
  .where({
    user_id: user_id,
    plan_date: normalizedTargetDate,
    plan_type: determinedPlanType,
    is_stats_record: false
  })
  .first();

// NEW (finds the correct plan for the specific assignment)
const existing = await db('daily_training_plans')
  .where({
    user_id: user_id,
    plan_date: normalizedTargetDate,
    plan_type: determinedPlanType,
    source_plan_id: actualApprovalId, // ← Now includes source_plan_id
    is_stats_record: false
  })
  .first();
```

## Testing Multiple Plans

To test that multiple plans work correctly:

1. **Create 2 assignments** for the same user:
   ```sql
   INSERT INTO training_plan_assignments (user_id, web_plan_id, start_date, end_date, ...)
   VALUES (2, 1, '2025-12-07', '2026-01-07', ...); -- Muscle Gain
   
   INSERT INTO training_plan_assignments (user_id, web_plan_id, start_date, end_date, ...)
   VALUES (2, 2, '2025-12-07', '2026-01-20', ...); -- Weight Loss
   ```

2. **Create daily plans** for the same date:
   ```sql
   -- Should succeed - different source_plan_id
   INSERT INTO daily_training_plans (user_id, plan_date, plan_type, source_plan_id, ...)
   VALUES (2, '2025-12-07', 'web_assigned', 87, ...);
   
   INSERT INTO daily_training_plans (user_id, plan_date, plan_type, source_plan_id, ...)
   VALUES (2, '2025-12-07', 'web_assigned', 88, ...);
   ```

3. **Verify** both plans are returned by `GET /api/dailyTraining/mobile/plans`

## Important Notes

1. **NULL source_plan_id**: If `source_plan_id` is NULL, PostgreSQL treats each NULL as distinct, so multiple NULLs won't conflict. However, it's recommended to always set `source_plan_id` when possible.

2. **Plan Type Consistency**: Plans from the same source should always use the same `plan_type`. For example, all plans from `training_plan_assignments` should use `'web_assigned'`.

3. **Completion Tracking**: Each plan tracks completion independently. Completing Day 1 of "Muscle Gain" doesn't affect Day 1 of "Weight Loss".

4. **Frontend Display**: The frontend should group plans by `source_plan_id` or `assignment_id` to display them separately in the "Scheduled Workouts" section.

